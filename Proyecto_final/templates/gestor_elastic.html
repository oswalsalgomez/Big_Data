<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>
<script>
    // üî¥ Esta l√≠nea se elimina, ya que no existe 'current-year' y el a√±o se maneja en base.html
    // document.getElementById('current-year').textContent = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', function() {
        cargarIndices();
    });

    function cargarIndices() {
        document.getElementById('div_cargando').style.display = 'block';
        
        fetch('{{ url_for("listar_indices_elastic") }}')
            .then(response => response.json())
            .then(data => {
                const tablaIndices = document.getElementById('tablaIndices');
                tablaIndices.innerHTML = '';
                
                if (!Array.isArray(data) || data.length === 0) {
                    tablaIndices.innerHTML = '<tr><td colspan="5" class="text-center">No hay √≠ndices disponibles</td></tr>';
                } else {
                    data.forEach(indice => {
                        const row = document.createElement('tr');
                        
                        let saludBadge = '';
                        const salud = indice.salud || 'unknown';
                        if (salud === 'green') {
                            saludBadge = '<span class="badge bg-success">Verde</span>';
                        } else if (salud === 'yellow') {
                            saludBadge = '<span class="badge bg-warning">Amarillo</span>';
                        } else if (salud === 'red') {
                            saludBadge = '<span class="badge bg-danger">Rojo</span>';
                        } else {
                            saludBadge = '<span class="badge bg-secondary">Desconocido</span>';
                        }
                        
                        let estadoBadge = '';
                        const estado = indice.estado || 'unknown';
                        if (estado === 'open') {
                            estadoBadge = '<span class="badge bg-success">Abierto</span>';
                        } else {
                            estadoBadge = '<span class="badge bg-secondary">Cerrado</span>';
                        }
                        
                        row.innerHTML = `
                            <td><strong>${indice.nombre || ''}</strong></td>
                            <td>${indice.total_documentos || 0}</td>
                            <td>${indice.tama√±o || '0b'}</td>
                            <td>${saludBadge}</td>
                            <td>${estadoBadge}</td>
                        `;
                        tablaIndices.appendChild(row);
                    });
                }
                
                document.getElementById('div_cargando').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar la lista de √≠ndices');
                document.getElementById('div_cargando').style.display = 'none';
            });
    }

    function ejecutarComando() {
        const tipoOperacion = document.querySelector('input[name="tipo_operacion"]:checked').value;
        const queryText = document.getElementById('queryTextarea').value.trim();
        
        if (!queryText) {
            alert('Por favor, ingrese una query o comando');
            return;
        }
        
        try {
            JSON.parse(queryText);
        } catch (e) {
            alert('Error: El texto ingresado no es un JSON v√°lido.\n' + e.message);
            return;
        }
        
        document.getElementById('div_cargando').style.display = 'block';
        document.getElementById('divResultadosQuery').style.display = 'none';
        document.getElementById('divResultadosDML').style.display = 'none';
        
        if (tipoOperacion === 'QUERY') {
            ejecutarQuery(queryText);
        } else if (tipoOperacion === 'DML') {
            ejecutarDML(queryText);
        }
    }

    function ejecutarQuery(queryText) {
        fetch('{{ url_for("ejecutar_query_elastic") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ query: queryText })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('div_cargando').style.display = 'none';
            
            if (data.success) {
                document.getElementById('divResultadosQuery').style.display = 'block';
                
                document.getElementById('totalHits').textContent = data.total || 0;
                
                const divAggs = document.getElementById('divAggregations');
                if (data.aggs && Object.keys(data.aggs).length > 0) {
                    divAggs.textContent = JSON.stringify(data.aggs, null, 2);
                } else {
                    divAggs.textContent = 'No hay aggregations en esta consulta';
                }
                
                const tablaHits = document.getElementById('tablaHits');
                tablaHits.innerHTML = '';
                
                if (data.hits && data.hits.length > 0) {
                    data.hits.forEach(hit => {
                        const row = document.createElement('tr');
                        const source = hit._source || {};
                        
                        row.innerHTML = `
                            <td>${hit._id || ''}</td>
                            <td>${hit._index || ''}</td>
                            <td>${hit._score ? hit._score.toFixed(4) : 'N/A'}</td>
                            <td><pre class="mb-0" style="font-size: 0.75rem; max-height: 150px; overflow-y: auto;">${JSON.stringify(source, null, 2)}</pre></td>
                        `;
                        tablaHits.appendChild(row);
                    });
                } else {
                    tablaHits.innerHTML = '<tr><td colspan="4" class="text-center">No hay resultados</td></tr>';
                }
            } else {
                alert('Error al ejecutar la query: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('div_cargando').style.display = 'none';
            alert('Error al ejecutar la query');
        });
    }

    function ejecutarDML(queryText) {
        fetch('{{ url_for("ejecutar_dml_elastic") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ comando: queryText })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('div_cargando').style.display = 'none';
            
            if (data.success) {
                // üîß aqu√≠ estaba el bug: faltaba .style.display
                document.getElementById('divResultadosDML').style.display = 'block';
                const divResultado = document.getElementById('divResultadoDML');
                divResultado.textContent = JSON.stringify(data.data, null, 2);
                
                setTimeout(() => {
                    cargarIndices();
                }, 1000);
            } else {
                alert('Error al ejecutar el comando DML: ' + (data.error || 'Error desconocido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('div_cargando').style.display = 'none';
            alert('Error al ejecutar el comando DML');
        });
    }

    function limpiarFormulario() {
        document.getElementById('queryTextarea').value = '';
        document.getElementById('divResultadosQuery').style.display = 'none';
        document.getElementById('divResultadosDML').style.display = 'none';
    }
</script>
